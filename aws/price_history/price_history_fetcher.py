import boto3
import os
import json
import psycopg2
import time
from psycopg2.extras import execute_batch
from typing import List, Dict, Optional
from simple_crawler import SimpleCrawler


class PriceHistoryFetcher(SimpleCrawler):
    """Fetches and stores price history for properties"""

    def __init__(self, s3_bucket: Optional[str] = None, s3_prefix: Optional[str] = None, session_city: str = "Collingswood"):
        super().__init__()
        self.headers.update({
            'accept': '*/*',
            'accept-language': 'en-US,en;q=0.9',
            'content-type': 'application/json',
            'origin': 'https://www.zillow.com',
            'priority': 'u=1, i',
            'client-id': 'not-for-sale-sub-app-browser-client',
            'x-enabled-listings-flag': 'restricted',
            'x-z-enable-oauth-conversion': 'true',
        })
        self.s3_bucket = s3_bucket or os.getenv('ZILLOW_S3_BUCKET')
        self.s3_prefix = s3_prefix or os.getenv('ZILLOW_S3_PREFIX', '../../crawler/session_data')
        self.session_city = session_city
        self._s3_client = None

        # Load session data (cookies.json) on initialization
        session_data = self._load_session_data(session_city)
        self.load_cookies(session_data.get("cookies.json", {}))

    def get_property_pricing_history(self, zpid: int):
        """Fetch price history from Zillow GraphQL API"""
        data = {
    'operationName': 'NotForSaleShopperPlatformFullRenderQuery',
    'variables': {
        'zpid': zpid,
        'altId': None,
        'deviceType': 'desktop',
        'deviceTypeV2': 'WEB_DESKTOP',
        'useOmpV2': True,
        'includeLastSoldListing': False,
    },
    'query': 'query NotForSaleShopperPlatformFullRenderQuery($zpid: ID!, $altId: ID, $deviceType: deviceType, $deviceTypeV2: OmpV2DeviceInput, $useOmpV2: Boolean!, $includeLastSoldListing: Boolean = false) {\n  property(zpid: $zpid, palsId: $altId) {\n    ...DebugPanel_property\n    ...NfsActionBarContent_property\n    ...NfsMediaColumnContent_property\n    ...NfsNavBarContent_property\n    ...NfsSummaryContent_property\n    ...NfsLightboxes_property\n    ...NfsDataViewContent_property\n    ...PageViewTracker_property\n    ...UniversalAnalyticsDataLayerFragment_property\n    ...NotForSaleSearchPageStateParams_property\n    ...LastSoldListing_property\n    rentalMarketingTreatments\n    palsId\n  }\n  viewer {\n    ...DebugPanel_viewer\n    ...viewerManager_viewer\n    ...NfsActionBarContent_viewer\n    ...NfsLightboxes_viewer\n    ...NfsDataViewContent_viewer\n    ...PageViewTracker_viewer\n  }\n  abTests {\n    ...abTestManager_abTests\n    ...NfsDataViewContent_abTests\n    ...UniversalAnalyticsDataLayerFragment_abTests\n    ...OwnerOptions_abTests\n  }\n}\n\nfragment DebugPanel_property on Property {\n  zpid\n  listingSource\n  listingAccount {\n    zuid\n    email\n  }\n  ownerAccount {\n    zuid\n  }\n  lfaViewPropertyPageUrl\n  listingOwnerConfigIDs\n  postingPresentationTypes\n  maloneId\n}\n\nfragment NfsActionBarContent_property on Property {\n  ...ActionBarController_property\n  ...ReleaseOwnership_property\n  ...ClaimOwnership_property\n  ...CSPropertyUpdatePage_property\n  ...CSMoveHomeMapLocation_property\n  ...PropertyEventLog_property\n  ...EditPropertyHistory_property\n  ...VerifyOwnership_property\n  ...DsEditButton_property\n}\n\nfragment ActionBarController_property on Property {\n  ...DsActionBar_property\n}\n\nfragment DsActionBar_property on Property {\n  zpid\n  city\n  state\n  homeStatus\n  ...SaveHome_property\n  ...SuperShareMenu_property\n}\n\nfragment SaveHome_property on Property {\n  address {\n    streetAddress\n    city\n    state\n    zipcode\n  }\n  homeStatus\n  isListingClaimedByCurrentSignedInUser\n  isCurrentSignedInAgentResponsible\n  zpid\n  bedrooms\n  bathrooms\n  price\n  yearBuilt\n}\n\nfragment SuperShareMenu_property on Property {\n  ...Share_property\n}\n\nfragment Share_property on Property {\n  zpid\n  streetAddress\n  city\n  state\n  zipcode\n  homeStatus\n  homeType\n  bedrooms\n  bathrooms\n  livingAreaValue\n  livingAreaUnitsShort\n  address {\n    streetAddress\n    city\n    state\n    zipcode\n  }\n  attributionInfo {\n    mlsId\n    mlsName\n    providerLogo\n  }\n  listing_sub_type {\n    is_FSBA\n    is_FSBO\n    is_pending\n    is_newHome\n    is_foreclosure\n    is_comingSoon\n    is_bankOwned\n    is_forAuction\n  }\n  responsivePhotos: photos {\n    url\n  }\n}\n\nfragment ReleaseOwnership_property on Property {\n  zpid\n  isListingClaimedByCurrentSignedInUser\n  isCurrentSignedInUserVerifiedOwner\n}\n\nfragment ClaimOwnership_property on Property {\n  zpid\n  isListingClaimedByCurrentSignedInUser\n  isCurrentSignedInUserVerifiedOwner\n}\n\nfragment CSPropertyUpdatePage_property on Property {\n  propertyUpdatePageLink\n}\n\nfragment CSMoveHomeMapLocation_property on Property {\n  moveHomeMapLocationLink\n}\n\nfragment PropertyEventLog_property on Property {\n  propertyEventLogLink\n}\n\nfragment EditPropertyHistory_property on Property {\n  editPropertyHistorylink\n}\n\nfragment VerifyOwnership_property on Property {\n  zpid\n  isCurrentSignedInUserVerifiedOwner\n  isVerifiedClaimedByCurrentSignedInUser\n}\n\nfragment DsEditButton_property on Property {\n  ...EditFactsLink_property\n}\n\nfragment EditFactsLink_property on Property {\n  zpid\n  listingDataSource\n}\n\nfragment NfsMediaColumnContent_property on Property {\n  ...NfsMediaStream_property\n  ...NfsPhotoCarousel_property\n}\n\nfragment NfsMediaStream_property on Property {\n  responsivePhotos: photos {\n    caption\n    subjectType\n    url\n    mixedSources(aspectRatio: FourThirds) {\n      jpeg {\n        url\n        width\n      }\n    }\n  }\n  ...StaticMap_property\n}\n\nfragment StaticMap_property on Property {\n  staticMap(\n    featureArea: "hdpMediaWall"\n    shouldGetAdditionalHighResSources: true\n    zoom: 15\n  ) {\n    sources(aspectRatio: FourThirds, minWidth: 150, maxWidth: 768) {\n      width\n      url\n      isHighResolutionStaticMap\n    }\n  }\n}\n\nfragment NfsPhotoCarousel_property on Property {\n  ...getPhotoTiles_property\n}\n\nfragment getPhotoTiles_property on Property {\n  responsivePhotos: photos {\n    caption\n    mixedSources(aspectRatio: FourThirds) {\n      jpeg {\n        url\n        width\n      }\n      webp {\n        url\n        width\n      }\n    }\n  }\n}\n\nfragment NfsNavBarContent_property on Property {\n  ...NavBarController_property\n}\n\nfragment NavBarController_property on Property {\n  ...DsNavBar_property\n}\n\nfragment DsNavBar_property on Property {\n  topNavJson\n}\n\nfragment NfsSummaryContent_property on Property {\n  ...NfsChip_property\n}\n\nfragment NfsChip_property on Property {\n  ...FactsRow_property\n  ...AddressRow_property\n  ...StatusAndZestimateRow_property\n  ...MortgageRow_property\n}\n\nfragment FactsRow_property on Property {\n  ...BedBathBeyond_property\n}\n\nfragment BedBathBeyond_property on Property {\n  bedrooms\n  bathrooms\n  livingArea\n  homeType\n  lotSize\n  lotAreaValue\n  lotAreaUnits\n  livingAreaValue\n  livingAreaUnitsShort\n  state\n  resoFacts {\n    bathroomsFull\n    bathroomsThreeQuarter\n    bathroomsHalf\n    bathroomsOneQuarter\n  }\n}\n\nfragment AddressRow_property on Property {\n  ...Address_property\n}\n\nfragment Address_property on Property {\n  streetAddress\n  city\n  state\n  zipcode\n  isUndisclosedAddress\n  formattedChip(xConsumerUsername: "hdp-web") {\n    location {\n      fullValue\n    }\n  }\n}\n\nfragment StatusAndZestimateRow_property on Property {\n  zpid\n  homeStatus\n  zestimate\n  rentZestimate\n  currency\n  hideZestimate\n  dateSoldString\n  taxAssessedValue\n  taxAssessedYear\n  ...StatusArea_property\n}\n\nfragment StatusArea_property on Property {\n  homeStatus\n  currency\n  zipcode\n  homeType\n  contingentListingType\n  attributionInfo {\n    trueStatus\n  }\n  listing_sub_type {\n    is_FSBA\n    is_FSBO\n    is_pending\n    is_newHome\n    is_bankOwned\n    is_openHouse\n    is_forAuction\n    is_comingSoon\n    is_foreclosure\n  }\n}\n\nfragment MortgageRow_property on Property {\n  country\n  ...EstimatedPayment_property\n}\n\nfragment EstimatedPayment_property on Property {\n  homeStatus\n  price\n  monthlyHoaFee\n  mortgageZHLRates {\n    thirtyYearFixedBucket {\n      rate\n      rateSource\n      lastUpdated\n    }\n  }\n  propertyTaxRate\n  homeType\n  listing_sub_type {\n    is_forAuction\n    is_FSBA\n    is_FSBO\n    is_pending\n    is_comingSoon\n    is_newHome\n    is_foreclosure\n    is_bankOwned\n    is_openHouse\n  }\n  zipcode\n  state\n  country\n  listingMetadata {\n    FlexibleLayoutAB\n  }\n}\n\nfragment NfsLightboxes_property on Property {\n  ...ReportProblemLightbox_property\n  ...Share_property\n  ...MapLightboxContainer_property\n  ...MixedMediaLightbox_property\n}\n\nfragment ReportProblemLightbox_property on Property {\n  zpid\n  homeStatus\n}\n\nfragment MapLightboxContainer_property on Property {\n  ...GalleryLightboxMapGoogle_property\n}\n\nfragment GalleryLightboxMapGoogle_property on Property {\n  zpid\n  streetAddress\n  city\n  state\n  zipcode\n  latitude\n  longitude\n  isUndisclosedAddress\n  streetViewTileImageUrlMediumLatLong: googleStreetViewImageSignedUrl(\n    featureArea: "hdpMediaWall"\n    locationType: LAT_LONG\n    width: 400\n    height: 250\n  )\n  streetViewTileImageUrlMediumAddress: googleStreetViewImageSignedUrl(\n    featureArea: "hdpMediaWall"\n    locationType: ADDRESS\n    width: 400\n    height: 250\n  )\n  ...GalleryLightboxActionButtons_property\n  ...GoogleStreetViewPanorama_property\n  ...LotLinesMap_property\n  ...GetShareWithCaseManagerEnabled_property\n}\n\nfragment LotLinesMap_property on Property {\n  latitude\n  longitude\n  homeStatus\n  zpid\n  price\n  thumb: photos(count: 1, size: THUMBNAIL) {\n    url\n  }\n  neighborhoodMapThumb: photos(count: 1, size: S) {\n    url\n  }\n}\n\nfragment GalleryLightboxActionButtons_property on Property {\n  zpid\n  homeStatus\n  isPremierBuilder\n  address {\n    streetAddress\n    city\n    state\n    zipcode\n  }\n  ...SaveButton_property\n  ...Variant_property\n}\n\nfragment SaveButton_property on Property {\n  ...SaveHome_property\n}\n\nfragment Variant_property on Property {\n  isShowcaseListing\n  isPremierBuilder\n  homeStatus\n  listing_sub_type {\n    is_FSBO\n    is_FSBA\n    is_newHome\n    is_foreclosure\n    is_bankOwned\n    is_forAuction\n    is_comingSoon\n  }\n  zpid\n  state\n}\n\nfragment GoogleStreetViewPanorama_property on Property {\n  zpid\n  longitude\n  latitude\n  streetViewMetadataUrlMapLightboxAddress: googleStreetViewMetadataSignedUrl(\n    featureArea: "hdpMapLightbox"\n    locationType: ADDRESS\n  )\n}\n\nfragment GetShareWithCaseManagerEnabled_property on Property {\n  isHousingConnector\n  homeStatus\n}\n\nfragment MixedMediaLightbox_property on Property {\n  zpid\n  homeStatus\n  photoCount\n  ...GalleryLightboxActionButtons_property\n  ...ShouldShowVideo_property\n  ...ShouldShowVirtualTour_property\n  ...VideoContainer_property\n  ...GalleryLightboxResponsiveGallery_property\n  ...CommunityStyle_property\n  ...GalleryLightboxThirdPartyVirtualTour_property\n  ...GetShareWithCaseManagerEnabled_property\n  responsivePhotosOriginalRatio: photos {\n    caption\n    key: photoKey\n    mixedSources(aspectRatio: Original) {\n      jpeg {\n        url\n        width\n      }\n      webp {\n        url\n        width\n      }\n    }\n  }\n  ...couldShowEmbeddedThirdPartyVirtualTour_property\n}\n\nfragment ShouldShowVideo_property on Property {\n  homeStatus\n  isZillowOwned\n  hasPublicVideo\n  primaryPublicVideo {\n    sources {\n      src\n    }\n  }\n  richMediaVideos {\n    mp4Url\n    hlsUrl\n  }\n}\n\nfragment ShouldShowVirtualTour_property on Property {\n  homeStatus\n  richMedia {\n    virtualTour {\n      viewerUrl\n      revisionId\n    }\n  }\n}\n\nfragment VideoContainer_property on Property {\n  ...VideoWalkthroughContainer_property\n}\n\nfragment VideoWalkthroughContainer_property on Property {\n  primaryPublicVideo {\n    videoIdEncoded\n    postingClient\n    sourceVideoWidth\n    sourceVideoHeight\n    sources {\n      presetName\n      src\n      type\n    }\n  }\n  richMediaVideos {\n    mp4Url\n    hlsUrl\n  }\n}\n\nfragment GalleryLightboxResponsiveGallery_property on Property {\n  homeStatus\n  isPremierBuilder\n  ...GalleryLightboxActionButtons_property\n  ...GalleryFooter_property\n}\n\nfragment GalleryFooter_property on Property {\n  ...GalleryLightboxHomeInfo_property\n}\n\nfragment GalleryLightboxHomeInfo_property on Property {\n  price\n  lastSoldPrice\n  bedrooms\n  bathrooms\n  livingArea\n  livingAreaValue\n  livingAreaUnits\n  homeStatus\n  homeType\n  currency\n  listing_sub_type {\n    is_newHome\n    is_FSBO\n    is_bankOwned\n    is_foreclosure\n    is_forAuction\n    is_comingSoon\n  }\n  contingentListingType\n  attributionInfo {\n    trueStatus\n  }\n  isPremierBuilder\n  newConstructionType\n}\n\nfragment GalleryLightboxThirdPartyVirtualTour_property on Property {\n  thirdPartyVirtualTour {\n    lightboxUrl\n  }\n  ...couldShowEmbeddedThirdPartyVirtualTour_property\n}\n\nfragment couldShowEmbeddedThirdPartyVirtualTour_property on Property {\n  thirdPartyVirtualTour {\n    lightboxUrl\n  }\n  ...couldShowThirdPartyVirtualTour_property\n}\n\nfragment couldShowThirdPartyVirtualTour_property on Property {\n  homeStatus\n  hasApprovedThirdPartyVirtualTourUrl\n  thirdPartyVirtualTour {\n    approved\n  }\n}\n\nfragment CommunityStyle_property on Property {\n  homeType\n}\n\nfragment NfsDataViewContent_property on Property {\n  stateId\n  countyId\n  cityId\n  country\n  isNonOwnerOccupied\n  ...HomeValue_property\n  ...NfsFactsAndFeatures_property\n  ...NfsOverview_property\n  ...DsPriceAndTaxHistory_property\n  ...DsNeighborhood_property\n  ...DsNearbySchools_property\n  ...OmpDsNfsUpsellTop_property\n  ...OmpDsNfsUpsellBottom_property\n  ...OmpDsNfsUpsellRight_property\n  ...WaysToSell_property\n  ...OwnerOptions_property\n  ...Tcos_property\n  ...DsFooterSection_property\n  ...DQFragment_property\n  ...ComparableHomesModule_property\n  ...ClaimsUpsell_property\n  ...InlineSellerAttribution_property\n  ...OmpV2WebOMHDPCombo_property\n  ...OmpV2WebOMHDPBottom_property\n}\n\nfragment HomeValue_property on Property {\n  country\n  ...ZestimateSummary_property\n}\n\nfragment ZestimateSummary_property on Property {\n  zpid\n  homeStatus\n  ...MessagePrompt_property\n  ...PrimaryZestimate_property\n  ...ZestimateForecast_property\n  ...ZestimateChange_property\n  ...ZestimateRange_property\n  ...ZestimatePerSqft_property\n}\n\nfragment MessagePrompt_property on Property {\n  zpid\n  yearBuilt\n  livingArea\n  livingAreaValue\n  bathrooms\n  bedrooms\n  homeType\n  zestimate\n  price\n  homeStatus\n  isListingClaimedByCurrentSignedInUser\n}\n\nfragment PrimaryZestimate_property on Property {\n  zpid\n  rentZestimate\n  zestimate\n  homeStatus\n  listingDataSource\n}\n\nfragment ZestimateForecast_property on Property {\n  zestimate\n  forecast\n}\n\nfragment ZestimateChange_property on Property {\n  zestimate\n  zestimateMinus30\n  rentZestimate\n  restimateMinus30\n}\n\nfragment ZestimateRange_property on Property {\n  zestimate\n  zestimateLowPercent\n  zestimateHighPercent\n  rentZestimate\n  restimateLowPercent\n  restimateHighPercent\n}\n\nfragment ZestimatePerSqft_property on Property {\n  homeType\n  livingAreaValue\n  livingAreaUnits\n  lotAreaValue\n  lotAreaUnits\n}\n\nfragment NfsFactsAndFeatures_property on Property {\n  ...NfsFactsAndFeaturesCommon_property\n  ...ServicesAvailability_property\n}\n\nfragment NfsFactsAndFeaturesCommon_property on Property {\n  ...FactsAndFeaturesCommon_property\n  ...EditFactsLink_property\n  attributionInfo {\n    listingAgreement\n  }\n  resoFacts {\n    aboveGradeFinishedArea\n    additionalParcelsDescription\n    architecturalStyle\n    belowGradeFinishedArea\n    builderModel\n    builderName\n    buildingArea\n    buildingAreaSource\n    buildingFeatures\n    constructionMaterials\n    exteriorFeatures\n    foundationDetails\n    frontageLength\n    frontageType\n    hasAdditionalParcels\n    hasPetsAllowed\n    hasRentControl\n    hasHomeWarranty\n    inclusions\n    incomeIncludes\n    isNewConstruction\n    listingTerms\n    livingAreaRange\n    livingAreaRangeUnits\n    livingArea\n    lotSizeDimensions\n    numberOfUnitsVacant\n    otherStructures\n    ownership\n    parcelNumber\n    propertyCondition\n    propertySubType\n    structureType\n    topography\n    vegetation\n    woodedArea\n    yearBuiltEffective\n  }\n}\n\nfragment FactsAndFeaturesCommon_property on Property {\n  state\n  currency\n  homeStatus\n  homeType\n  resoFacts {\n    accessibilityFeatures\n    additionalFeeInfo\n    associations {\n      feeFrequency\n      name\n      phone\n    }\n    associationFee\n    associationAmenities\n    associationFee2\n    associationFeeIncludes\n    associationName\n    associationName2\n    associationPhone\n    associationPhone2\n    basementYN\n    buildingName\n    buyerAgencyCompensation\n    buyerAgencyCompensationType\n    appliances\n    atAGlanceFacts {\n      factLabel\n      factValue\n    }\n    attic\n    availabilityDate\n    basement\n    bathrooms\n    bathroomsFull\n    bathroomsHalf\n    bathroomsOneQuarter\n    bathroomsPartial\n    bathroomsFloat\n    bathroomsThreeQuarter\n    bedrooms\n    bodyType\n    canRaiseHorses\n    carportParkingCapacity\n    cityRegion\n    commonWalls\n    communityFeatures\n    compensationBasedOn\n    contingency\n    cooling\n    coveredParkingCapacity\n    cropsIncludedYN\n    cumulativeDaysOnMarket\n    developmentStatus\n    doorFeatures\n    electric\n    elevation\n    elevationUnits\n    entryLevel\n    entryLocation\n    exclusions\n    feesAndDues {\n      type\n      fee\n      name\n      phone\n    }\n    fencing\n    fireplaceFeatures\n    fireplaces\n    flooring\n    foundationArea\n    furnished\n    garageParkingCapacity\n    gas\n    greenBuildingVerificationType\n    greenEnergyEfficient\n    greenEnergyGeneration\n    greenIndoorAirQuality\n    greenSustainability\n    greenWaterConservation\n    hasAssociation\n    hasAttachedGarage\n    hasAttachedProperty\n    hasCooling\n    hasCarport\n    hasElectricOnProperty\n    hasFireplace\n    hasGarage\n    hasHeating\n    hasLandLease\n    hasOpenParking\n    hasSpa\n    hasPrivatePool\n    hasView\n    hasWaterfrontView\n    heating\n    highSchool\n    highSchoolDistrict\n    hoaFee\n    hoaFeeTotal\n    homeType\n    horseAmenities\n    horseYN\n    interiorFeatures\n    irrigationWaterRightsAcres\n    irrigationWaterRightsYN\n    isSeniorCommunity\n    landLeaseAmount\n    landLeaseExpirationDate\n    laundryFeatures\n    levels\n    listingId\n    lotFeatures\n    lotSize\n    livingQuarters {\n      livingArea\n      livingAreaUnits\n      areaTotal\n      areaTotalUnits\n      features\n      livingQuarterType\n    }\n    mainLevelBathrooms\n    mainLevelBedrooms\n    marketingType\n    middleOrJuniorSchool\n    middleOrJuniorSchoolDistrict\n    municipality\n    numberOfUnitsInCommunity\n    offerReviewDate\n    onMarketDate\n    openParkingCapacity\n    otherEquipment\n    otherFacts {\n      name\n      value\n    }\n    otherParking\n    ownershipType\n    parkingCapacity\n    parkingFeatures\n    patioAndPorchFeatures\n    poolFeatures\n    pricePerSquareFoot\n    roadSurfaceType\n    roofType\n    rooms {\n      area\n      description\n      dimensions\n      level\n      features\n      roomArea\n      roomAreaSource\n      roomAreaUnits\n      roomDescription\n      roomDimensions\n      roomFeatures\n      roomLength\n      roomLengthWidthSource\n      roomLengthWidthUnits\n      roomLevel\n      roomType\n      roomWidth\n    }\n    securityFeatures\n    sewer\n    spaFeatures\n    specialListingConditions\n    stories\n    storiesTotal\n    subAgencyCompensation\n    subAgencyCompensationType\n    subdivisionName\n    totalActualRent\n    transactionBrokerCompensation\n    transactionBrokerCompensationType\n    utilities\n    view\n    waterSource\n    waterBodyName\n    waterfrontFeatures\n    waterView\n    waterViewYN\n    windowFeatures\n    yearBuilt\n    zoning\n    zoningDescription\n  }\n}\n\nfragment ServicesAvailability_property on Property {\n  ...TelecomAd_property\n}\n\nfragment TelecomAd_property on Property {\n  adTargets\n}\n\nfragment NfsOverview_property on Property {\n  description\n  whatILove\n  listingDataSource\n  ...AsyncListingAttributionOverview_property\n}\n\nfragment AsyncListingAttributionOverview_property on Property {\n  ...ListingAttributionOverview_property\n}\n\nfragment ListingAttributionOverview_property on Property {\n  attributionInfo {\n    agentEmail\n    agentLicenseNumber\n    agentName\n    agentPhoneNumber\n    attributionTitle\n    brokerName\n    brokerPhoneNumber\n    buyerAgentMemberStateLicense\n    buyerAgentName\n    buyerBrokerageName\n    coAgentLicenseNumber\n    coAgentName\n    coAgentNumber\n    lastChecked\n    lastUpdated\n    listingOffices {\n      associatedOfficeType\n      officeName\n    }\n    listingAgents {\n      associatedAgentType\n      memberFullName\n      memberStateLicense\n    }\n    mlsDisclaimer\n    mlsId\n    mlsName\n    providerLogo\n  }\n  listing_sub_type {\n    is_FSBO\n  }\n  listingMetadata {\n    mustAttributeOfficeNameBeforeAgentName\n    mustDisplayAttributionListAgentEmail\n    mustDisplayAttributionListAgentPhone\n    mustDisplayAttributionListingOfficePhone\n    mustDisplayDisclaimerBelowAttribution\n    mustHighlightAgentName\n    mustHighlightListOfficeName\n    mustMakeListingAgentContactable\n  }\n  pals {\n    name\n    palsId\n  }\n  resoFacts {\n    listAOR\n  }\n  ...SellerAttribution_property\n}\n\nfragment SellerAttribution_property on Property {\n  ...ListedBy_property\n}\n\nfragment ListedBy_property on Property {\n  zpid\n  listedBy {\n    id\n    elements {\n      id\n      text\n      action {\n        variant\n        url\n      }\n    }\n    textStyle\n  }\n}\n\nfragment DsNeighborhood_property on Property {\n  adTargets\n  ...DsNeighborhoodIncludingNearbyHomes_property\n}\n\nfragment DsNeighborhoodIncludingNearbyHomes_property on Property {\n  ...DsNeighborhoodCommon_property\n  nearbyHomes(count: 8) {\n    ...DsMiniCardGallery_property\n    ...DsMiniCardCarousel_property\n  }\n}\n\nfragment DsNeighborhoodCommon_property on Property {\n  homeStatus\n  price\n  rentZestimate\n  zestimate\n  homeValues {\n    region {\n      shortName\n      link\n      zhvi {\n        yoy\n        value\n      }\n      zhviForecast {\n        value\n      }\n    }\n  }\n  address {\n    zipcode\n  }\n  parentRegion {\n    name\n  }\n}\n\nfragment DsMiniCardGallery_property on Property {\n  zpid\n  ...DsMiniCard_property\n}\n\nfragment DsMiniCard_property on Property {\n  miniCardPhotos: photos(count: 1, size: S) {\n    url\n  }\n  ...DsMiniCardCommon_property\n}\n\nfragment DsMiniCardCommon_property on Property {\n  price\n  currency\n  bedrooms\n  bathrooms\n  livingArea\n  livingAreaValue\n  livingAreaUnits\n  livingAreaUnitsShort\n  listPriceIncludesRequiredMonthlyFees\n  baseRent\n  totalRequiredMonthlyMinFee\n  totalRequiredMonthlyMaxFee\n  state\n  listingMetadata {\n    comminglingCategoryIsRulesApplicable\n  }\n  resoFacts {\n    bathroomsOneQuarter\n    bathroomsHalf\n    bathroomsThreeQuarter\n    bathroomsFull\n  }\n  lotSize\n  lotAreaValue\n  lotAreaUnits\n  address {\n    streetAddress\n    city\n    state\n    zipcode\n  }\n  parentRegion {\n    name\n  }\n  formattedChip(xConsumerUsername: "hdp-web") {\n    location {\n      fullValue\n    }\n  }\n  latitude\n  longitude\n  zpid\n  homeStatus\n  homeType\n  hdpUrl\n  hdpTypeDimension\n  propertyTypeDimension\n  listingTypeDimension\n  listing_sub_type {\n    is_newHome\n    is_forAuction\n    is_bankOwned\n    is_foreclosure\n    is_FSBO\n    is_comingSoon\n  }\n  providerListingID\n  attributionInfo {\n    mlsId\n    mlsName\n    providerLogo\n    agentName\n    agentPhoneNumber\n    brokerName\n    brokerPhoneNumber\n    trueStatus\n  }\n  ...Variant_property\n  ...NcVariant_property\n}\n\nfragment NcVariant_property on Property {\n  isPremierBuilder\n  newConstructionType\n}\n\nfragment DsMiniCardCarousel_property on Property {\n  zpid\n  ...DsMiniCard_property\n}\n\nfragment DsNearbySchools_property on Property {\n  country\n  state\n  schools {\n    distance\n    name\n    rating\n    level\n    studentsPerTeacher\n    assigned\n    grades\n    link\n    type\n    size\n    totalCount\n    assigned\n    isAssigned\n  }\n  citySearchUrl {\n    text\n  }\n  ...DsResoSchools_property\n}\n\nfragment DsResoSchools_property on Property {\n  isPremierBuilder\n  resoFacts {\n    elementarySchool\n    middleOrJuniorSchool\n    highSchool\n    elementarySchoolDistrict\n  }\n  attributionInfo {\n    mlsName\n  }\n}\n\nfragment DsPriceAndTaxHistory_property on Property {\n  zpid\n  countyFIPS\n  parcelId\n  taxHistory {\n    time\n    taxPaid\n    taxIncreaseRate\n    value\n    valueIncreaseRate\n  }\n  priceHistory {\n    date\n    time\n    price\n    pricePerSquareFoot\n    priceChangeRate\n    event\n    source\n    buyerAgent {\n      photo {\n        url\n      }\n      profileUrl\n      name\n    }\n    sellerAgent {\n      photo {\n        url\n      }\n      profileUrl\n      name\n    }\n    showCountyLink\n    postingIsRental\n    attributeSource {\n      infoString1\n      infoString2\n      infoString3\n    }\n  }\n  currency\n  country\n  listing_sub_type {\n    is_forAuction\n    is_comingSoon\n  }\n}\n\nfragment OmpDsNfsUpsellTop_property on Property {\n  zpid\n  NFSHDPTopSlot: onsiteMessage(\n    placementNames: ["NFSHDPTopSlot"]\n    placementData: {deviceType: $deviceType}\n  ) @skip(if: $useOmpV2) {\n    ...onsiteMessage_fragment\n  }\n}\n\nfragment onsiteMessage_fragment on OnsiteMessageResultType {\n  eventId\n  decisionContext\n  messages {\n    skipDisplayReason\n    shouldDisplay\n    isGlobalHoldout\n    isPlacementHoldout\n    placementName\n    testPhase\n    bucket\n    placementId\n    passThrottle\n    lastModified\n    eventId\n    decisionContext\n    selectedTreatment {\n      id\n      name\n      component\n      status\n      renderingProps\n      lastModified\n    }\n    qualifiedTreatments {\n      id\n      name\n      status\n      lastModified\n    }\n  }\n}\n\nfragment OmpDsNfsUpsellBottom_property on Property {\n  zpid\n  NFSHDPBottomSlot: onsiteMessage(\n    placementNames: ["NFSHDPBottomSlot"]\n    placementData: {deviceType: $deviceType}\n  ) @skip(if: $useOmpV2) {\n    ...onsiteMessage_fragment\n  }\n}\n\nfragment OmpDsNfsUpsellRight_property on Property {\n  zpid\n  NFSHDPRightRail: onsiteMessage(\n    placementNames: ["NFSHDPRightRail"]\n    placementData: {deviceType: $deviceType}\n  ) @skip(if: $useOmpV2) {\n    ...onsiteMessage_fragment\n  }\n}\n\nfragment WaysToSell_property on Property {\n  zpid\n}\n\nfragment OwnerOptions_property on Property {\n  zpid\n  zipcode\n  zestimate\n  rentZestimate\n  currency\n  price\n  propertyTaxRate\n  hoaFee\n  adTargets\n  mortgageRates {\n    thirtyYearFixedRate\n  }\n}\n\nfragment Tcos_property on Property {\n  zpid\n  zestimate\n  dateSold\n  lastSoldPrice\n  price\n  city\n  state\n  county\n  homeStatus\n}\n\nfragment DsFooterSection_property on Property {\n  zpid\n  isRentalListingOffMarket\n  ...Comscore_property\n  ...DsHomeDetailsFooter_property\n  ...DsBreadcrumbs_property\n  adTargets\n}\n\nfragment Comscore_property on Property {\n  zpid\n  address {\n    streetAddress\n    state\n    city\n    zipcode\n  }\n  hdpUrl\n}\n\nfragment DsHomeDetailsFooter_property on Property {\n  listing_sub_type {\n    is_newHome\n  }\n  ...NearbyCitiesColumn_property\n  ...NearbyNeighborhoodsColumn_property\n  ...NearbyZipcodesColumn_property\n  ...OtherTopicsColumn_property\n  ...DsBreadcrumbs_property\n  ...CityApartmentsForRentSRPsColumn_property\n}\n\nfragment NearbyCitiesColumn_property on Property {\n  nearbyCities {\n    regionUrl {\n      path\n    }\n    name\n    body {\n      city\n      state\n    }\n  }\n}\n\nfragment NearbyNeighborhoodsColumn_property on Property {\n  nearbyNeighborhoods {\n    regionUrl {\n      path\n    }\n    name\n    body {\n      neighborhood\n      city\n      state\n    }\n  }\n}\n\nfragment NearbyZipcodesColumn_property on Property {\n  country\n  nearbyZipcodes {\n    regionUrl {\n      path\n    }\n    name\n    body {\n      zipcode\n      city\n      state\n    }\n  }\n}\n\nfragment OtherTopicsColumn_property on Property {\n  city\n  state\n  zipcode\n  cityId\n  citySearchUrl {\n    text\n    path\n  }\n  zipcodeSearchUrl {\n    path\n  }\n  apartmentsForRentInZipcodeSearchUrl {\n    path\n  }\n  housesForRentInZipcodeSearchUrl {\n    path\n  }\n}\n\nfragment DsBreadcrumbs_property on Property {\n  ...Breadcrumbs_property\n}\n\nfragment Breadcrumbs_property on Property {\n  streetAddress\n  abbreviatedAddress\n  city\n  state\n  county\n  zipcode\n  address {\n    neighborhood\n    community\n    subdivision\n  }\n  neighborhoodRegion {\n    name\n  }\n  building {\n    bdpUrl\n    buildingName\n  }\n  isUndisclosedAddress\n  boroughId\n  providerListingID\n  neighborhoodSearchUrl {\n    path\n  }\n  stateSearchUrl {\n    path\n  }\n  countySearchUrl {\n    text\n    path\n  }\n  citySearchUrl {\n    text\n    path\n  }\n  zipcodeSearchUrl {\n    path\n  }\n  boroughSearchUrl {\n    text\n    path\n  }\n  communityUrl {\n    path\n  }\n  ...Variant_property\n}\n\nfragment CityApartmentsForRentSRPsColumn_property on Property {\n  city\n  state\n  homeType\n}\n\nfragment ComparableHomesModule_property on Property {\n  ...CompsModule_property\n}\n\nfragment CompsModule_property on Property {\n  homeValuation(xConsumerUsername: "omhdp") {\n    comparables {\n      comps {\n        property {\n          ...CompsCarouselPropertyCard_property\n          ...CompsMapSection_property\n        }\n      }\n    }\n  }\n  ...CompsCarouselPropertyCard_property\n  ...CompsMapSection_property\n}\n\nfragment CompsCarouselPropertyCard_property on Property {\n  zestimate\n  lastSoldPrice\n  price\n  daysOnZillow\n  dateSold\n  currency\n  bedrooms\n  bathrooms\n  livingAreaValue\n  livingAreaUnits\n  livingAreaUnitsShort\n  lotAreaValue\n  lotAreaUnits\n  address {\n    streetAddress\n    city\n    state\n    zipcode\n  }\n  latitude\n  longitude\n  zpid\n  homeStatus\n  homeType\n  hdpUrl\n  listing_sub_type {\n    is_newHome\n    is_forAuction\n    is_bankOwned\n    is_foreclosure\n    is_FSBO\n    is_comingSoon\n  }\n  isUndisclosedAddress\n  attributionInfo {\n    mlsId\n    mlsName\n    providerLogo\n    agentName\n    agentPhoneNumber\n    brokerName\n    brokerPhoneNumber\n  }\n  compsCarouselPropertyPhotos: photos(count: 1, size: S) {\n    mixedSources(aspectRatio: FourThirds) {\n      jpeg {\n        url\n      }\n    }\n  }\n}\n\nfragment CompsMapSection_property on Property {\n  latitude\n  longitude\n}\n\nfragment DQFragment_property on Property {\n  listingMetadata {\n    FlexibleLayoutB\n    FlexibleLayoutC\n    FlexibleLayoutD\n    FlexibleLayoutE\n    FlexibleLayoutF\n    FlexibleLayoutG\n    FlexibleLayoutH\n    FlexibleLayoutI\n    FlexibleLayoutJ\n    FlexibleLayoutK\n    FlexibleLayoutL\n    FlexibleLayoutM\n    FlexibleLayoutN\n    FlexibleLayoutO\n    FlexibleLayoutP\n    FlexibleLayoutQ\n    FlexibleLayoutR\n    FlexibleLayoutS\n    FlexibleLayoutT\n    FlexibleLayoutU\n    FlexibleLayoutV\n    FlexibleLayoutW\n    FlexibleLayoutX\n    FlexibleLayoutY\n    FlexibleLayoutZ\n    FlexibleLayoutAA\n    FlexibleLayoutAB\n    passwordRequiredForZestimateMarketAnalysis\n    canShowAutomatedValuationDisplay\n    canShowTaxHistory\n    canShowPriceHistory\n    canShowUserGeneratedContent\n    isAdsRestricted\n    hidePriceAdjustmentFlexField\n    canCommingleComparables\n    canShowComparables\n    isSuperTrafficOptimized\n    mustDisplayDisclaimerBelowAttribution\n    mustDisplayFeedLogoInContactBox\n    canShowCroppedPhotos\n    canShowNonIDXMedia\n    canShowOnMap\n    comminglingCategory\n    mustDisplayAttributionAboveLocalFacts\n    mustDisplayAttributionListAgentEmail\n    mustDisplayAttributionListAgentPhone\n    mustDisplayAttributionListingOfficePhone\n    mustDisplayAuctionStatusAsSold\n    mustHighlightAgentName\n    mustHighlightMlsId\n    mustHighlightMlsStatus\n    mustHighlightListOfficeName\n    mustMakeListingAgentContactable\n    mustHighlightMarketingType\n    mustAttributeOfficeNameBeforeAgentName\n    canShowZillowLogoInHeader\n    canShowPrequalifiedLinkInChip\n    comminglingCategoryIsRulesApplicable\n  }\n}\n\nfragment ClaimsUpsell_property on Property {\n  zpid\n  isConfirmedClaimedByCurrentSignedInUser\n  isVerifiedClaimedByCurrentSignedInUser\n}\n\nfragment InlineSellerAttribution_property on Property {\n  ...ListedBy_property\n}\n\nfragment OmpV2WebOMHDPCombo_property on Property {\n  zpid\n  OmpV2WebOMHDPCombo: ompV2Message(\n    placementGroup: WEB_OMHDP_COMBO\n    config: {deviceType: $deviceTypeV2, placementSupportedComponents: [{placementName: WEB_OMHDP_TOP_SLOT, supportedComponents: [OmpV2WebUpsellCard, OmpV2WebEmphasizedUpsellCard, OmpV2WebBarGraphUpsellCard, OmpV2WebDynamicImageUpsellCard]}, {placementName: WEB_OMHDP_RIGHT_RAIL, supportedComponents: [OmpV2WebEmphasizedUpsellCard, OmpV2WebBarGraphUpsellCard, OmpV2WebDynamicImageUpsellCard]}, {placementName: WEB_OMHDP_MOBILE_FOOTER, supportedComponents: [OmpV2WebButtonUpsellCard]}]}\n  ) @include(if: $useOmpV2) {\n    placementGroupDecision {\n      eventId\n      placementGroup\n      experienceType\n      experienceName\n      error {\n        message\n      }\n      placementDecisions {\n        placementName\n        selectedMessage {\n          id\n          name\n          component {\n            __typename\n            ... on OmpV2WebEmphasizedUpsellCard {\n              emphasizedHeader: header\n              emphasizedBody: body {\n                beforeText\n                afterText\n                tooltip {\n                  trigger\n                  title\n                  subTitle\n                  content\n                  actionText\n                  actionUrl\n                }\n              }\n              primarySection {\n                label {\n                  __typename\n                  ... on OmpV2WebEmphasizedUpsellCardValueSectionText {\n                    text\n                    subText\n                    fontColor\n                    fontType\n                  }\n                  ... on OmpV2WebEmphasizedUpsellCardValueSectionTooltip {\n                    trigger\n                    title\n                    subTitle\n                    content\n                    actionText\n                    actionUrl\n                  }\n                }\n                value {\n                  __typename\n                  ... on OmpV2WebEmphasizedUpsellCardValueSectionText {\n                    text\n                    subText\n                    fontColor\n                    fontType\n                  }\n                  ... on OmpV2WebEmphasizedUpsellCardValueSectionTooltip {\n                    trigger\n                    title\n                    subTitle\n                    content\n                    actionText\n                    actionUrl\n                  }\n                }\n                hasDivider\n              }\n              secondarySection {\n                label {\n                  __typename\n                  ... on OmpV2WebEmphasizedUpsellCardValueSectionText {\n                    text\n                    subText\n                    fontColor\n                    fontType\n                  }\n                  ... on OmpV2WebEmphasizedUpsellCardValueSectionTooltip {\n                    trigger\n                    title\n                    subTitle\n                    content\n                    actionText\n                    actionUrl\n                  }\n                }\n                value {\n                  __typename\n                  ... on OmpV2WebEmphasizedUpsellCardValueSectionText {\n                    text\n                    subText\n                    fontColor\n                    fontType\n                  }\n                  ... on OmpV2WebEmphasizedUpsellCardValueSectionTooltip {\n                    trigger\n                    title\n                    subTitle\n                    content\n                    actionText\n                    actionUrl\n                  }\n                }\n                hasDivider\n              }\n              tertiarySection {\n                label {\n                  __typename\n                  ... on OmpV2WebEmphasizedUpsellCardValueSectionText {\n                    text\n                    subText\n                    fontColor\n                    fontType\n                  }\n                  ... on OmpV2WebEmphasizedUpsellCardValueSectionTooltip {\n                    trigger\n                    title\n                    subTitle\n                    content\n                    actionText\n                    actionUrl\n                  }\n                }\n                value {\n                  __typename\n                  ... on OmpV2WebEmphasizedUpsellCardValueSectionText {\n                    text\n                    subText\n                    fontColor\n                    fontType\n                  }\n                  ... on OmpV2WebEmphasizedUpsellCardValueSectionTooltip {\n                    trigger\n                    title\n                    subTitle\n                    content\n                    actionText\n                    actionUrl\n                  }\n                }\n                hasDivider\n              }\n              primaryCTA {\n                ctaUrl\n                ctaText\n                ctaButtonStyle\n                ctaSubText\n              }\n              isNarrowContainer\n              isPrimaryCTAFluid\n            }\n            ... on OmpV2WebUpsellCard {\n              simpleHeader: header\n              simpleBody: body\n              primaryCTA {\n                ctaUrl\n                ctaText\n                ctaButtonStyle\n                ctaSubText\n              }\n              secondaryCTA {\n                ctaUrl\n                ctaText\n                ctaButtonStyle\n                ctaSubText\n              }\n              imageMedia {\n                src\n                alt\n                width\n                height\n              }\n              advertisementText\n              advertisementMedia {\n                src\n                alt\n                width\n                height\n              }\n              hasBorder\n              dismissible\n              backgroundColor\n              mlsText\n            }\n            ... on OmpV2WebButtonUpsellCard {\n              requiredCTA: primaryCTA {\n                ctaUrl\n                ctaText\n                ctaButtonStyle\n                ctaSubText\n              }\n              secondaryCTA {\n                ctaUrl\n                ctaText\n                ctaButtonStyle\n                ctaSubText\n              }\n            }\n            ... on OmpV2WebBarGraphUpsellCard {\n              standingOfferPrice\n              titleMarkdownText\n              subtitleMarkdownText\n              subtitleTooltipTitle\n              subtitleTooltipText\n              bodyMarkdownText\n              bodyTextTooltipTitle\n              bodyTextTooltipText\n              leftBarTopText\n              leftBarBottomText\n              rightBarTopText\n              rightBarBottomText\n              requiredCTA: primaryCTA {\n                ctaUrl\n                ctaText\n                ctaButtonStyle\n                ctaSubText\n              }\n              barGraphType\n            }\n            ... on OmpV2WebDynamicImageUpsellCard {\n              standingOfferPrice\n              titleMarkdownText\n              subtitleMarkdownText\n              subtitleTooltipTitle\n              subtitleTooltipText\n              bodyMarkdownText\n              bodyTextTooltipTitle\n              bodyTextTooltipText\n              requiredImageMedia: imageMedia {\n                src\n                alt\n                width\n                height\n              }\n              requiredCTA: primaryCTA {\n                ctaUrl\n                ctaText\n                ctaButtonStyle\n                ctaSubText\n              }\n            }\n          }\n        }\n        eventMetadata {\n          exposureBlock {\n            randomizationKey\n            keyTypeCd\n            decisionToken\n            assignmentServiceCd\n            treatments\n            extendedInfo {\n              key\n              value\n            }\n          }\n          nbaBlock {\n            isNbaProcessed\n            surfaceId\n            position\n            joiningUuid\n            serviceErrorInd\n            serviceErrorTxt\n            selectedActionPositions {\n              key\n              value\n            }\n            userImpressionReportedInd\n            fallBackActionRankingUsedInd\n            selectedFallBackActions {\n              key\n              value\n            }\n          }\n          ompV2Block {\n            eventId\n            placementName\n            placementGroup\n            assignedExperienceType\n            selectedExperienceType\n            selectedExperienceName\n            selectedExperienceTrial\n            selectedExperienceTrialAssignment\n            qualifiedNbaActions\n            selectedNbaAction\n            qualifiedNbaMessages\n            selectedNbaMessage\n            selectedMessage\n            selectedMessageAttributions\n            qualifiedExperiencesMultivariateName\n            qualifiedExperiencesDefaultName\n            qualifiedExperiencesNbaName\n          }\n        }\n      }\n    }\n  }\n}\n\nfragment OmpV2WebOMHDPBottom_property on Property {\n  zpid\n  OmpV2WebOMHDPBottom: ompV2Message(\n    placementGroup: WEB_OMHDP_BOTTOM\n    config: {deviceType: $deviceTypeV2, placementSupportedComponents: [{placementName: WEB_OMHDP_BOTTOM_SLOT, supportedComponents: [OmpV2WebUpsellCard, OmpV2WebEmphasizedUpsellCard]}]}\n  ) @include(if: $useOmpV2) {\n    placementGroupDecision {\n      eventId\n      placementGroup\n      experienceType\n      experienceName\n      error {\n        message\n      }\n      placementDecisions {\n        placementName\n        selectedMessage {\n          id\n          name\n          component {\n            __typename\n            ... on OmpV2WebEmphasizedUpsellCard {\n              emphasizedHeader: header\n              emphasizedBody: body {\n                beforeText\n                afterText\n                tooltip {\n                  trigger\n                  title\n                  subTitle\n                  content\n                  actionText\n                  actionUrl\n                }\n              }\n              primarySection {\n                label {\n                  ... on OmpV2WebEmphasizedUpsellCardValueSectionText {\n                    text\n                    subText\n                    fontColor\n                    fontType\n                  }\n                  ... on OmpV2WebEmphasizedUpsellCardValueSectionTooltip {\n                    trigger\n                    title\n                    subTitle\n                    content\n                    actionText\n                    actionUrl\n                  }\n                }\n                value {\n                  __typename\n                  ... on OmpV2WebEmphasizedUpsellCardValueSectionText {\n                    text\n                    subText\n                    fontColor\n                    fontType\n                  }\n                  ... on OmpV2WebEmphasizedUpsellCardValueSectionTooltip {\n                    trigger\n                    title\n                    subTitle\n                    content\n                    actionText\n                    actionUrl\n                  }\n                }\n                hasDivider\n              }\n              secondarySection {\n                label {\n                  __typename\n                  ... on OmpV2WebEmphasizedUpsellCardValueSectionText {\n                    text\n                    subText\n                    fontColor\n                    fontType\n                  }\n                  ... on OmpV2WebEmphasizedUpsellCardValueSectionTooltip {\n                    trigger\n                    title\n                    subTitle\n                    content\n                    actionText\n                    actionUrl\n                  }\n                }\n                value {\n                  __typename\n                  ... on OmpV2WebEmphasizedUpsellCardValueSectionText {\n                    text\n                    subText\n                    fontColor\n                    fontType\n                  }\n                  ... on OmpV2WebEmphasizedUpsellCardValueSectionTooltip {\n                    trigger\n                    title\n                    subTitle\n                    content\n                    actionText\n                    actionUrl\n                  }\n                }\n                hasDivider\n              }\n              tertiarySection {\n                label {\n                  __typename\n                  ... on OmpV2WebEmphasizedUpsellCardValueSectionText {\n                    text\n                    subText\n                    fontColor\n                    fontType\n                  }\n                  ... on OmpV2WebEmphasizedUpsellCardValueSectionTooltip {\n                    trigger\n                    title\n                    subTitle\n                    content\n                    actionText\n                    actionUrl\n                  }\n                }\n                value {\n                  __typename\n                  ... on OmpV2WebEmphasizedUpsellCardValueSectionText {\n                    text\n                    subText\n                    fontColor\n                    fontType\n                  }\n                  ... on OmpV2WebEmphasizedUpsellCardValueSectionTooltip {\n                    trigger\n                    title\n                    subTitle\n                    content\n                    actionText\n                    actionUrl\n                  }\n                }\n                hasDivider\n              }\n              primaryCTA {\n                ctaUrl\n                ctaText\n                ctaButtonStyle\n                ctaSubText\n              }\n              isNarrowContainer\n              isPrimaryCTAFluid\n            }\n            ... on OmpV2WebUpsellCard {\n              simpleHeader: header\n              simpleBody: body\n              primaryCTA {\n                ctaUrl\n                ctaText\n                ctaButtonStyle\n                ctaSubText\n              }\n              secondaryCTA {\n                ctaUrl\n                ctaText\n                ctaButtonStyle\n                ctaSubText\n              }\n              imageMedia {\n                src\n                alt\n                width\n                height\n              }\n              advertisementText\n              advertisementMedia {\n                src\n                alt\n                width\n                height\n              }\n              hasBorder\n              dismissible\n              backgroundColor\n              mlsText\n            }\n          }\n        }\n        eventMetadata {\n          exposureBlock {\n            randomizationKey\n            keyTypeCd\n            decisionToken\n            assignmentServiceCd\n            treatments\n            extendedInfo {\n              key\n              value\n            }\n          }\n          nbaBlock {\n            isNbaProcessed\n            surfaceId\n            position\n            joiningUuid\n            serviceErrorInd\n            serviceErrorTxt\n            selectedActionPositions {\n              key\n              value\n            }\n            userImpressionReportedInd\n            fallBackActionRankingUsedInd\n            selectedFallBackActions {\n              key\n              value\n            }\n          }\n          ompV2Block {\n            eventId\n            placementName\n            placementGroup\n            assignedExperienceType\n            selectedExperienceType\n            selectedExperienceName\n            selectedExperienceTrial\n            selectedExperienceTrialAssignment\n            qualifiedNbaActions\n            selectedNbaAction\n            qualifiedNbaMessages\n            selectedNbaMessage\n            selectedMessage\n            selectedMessageAttributions\n            qualifiedExperiencesMultivariateName\n            qualifiedExperiencesDefaultName\n            qualifiedExperiencesNbaName\n          }\n        }\n      }\n    }\n  }\n}\n\nfragment PageViewTracker_property on Property {\n  zpid\n  address {\n    streetAddress\n    state\n    city\n    zipcode\n    neighborhood\n  }\n  zestimate\n  hdpUrl\n  price\n  homeType\n  homeStatus\n  listing_sub_type {\n    is_pending\n    is_comingSoon\n    is_FSBO\n    is_bankOwned\n    is_newHome\n    is_foreclosure\n    is_forAuction\n    is_FSBA\n  }\n  isRecentStatusChange\n  isNonOwnerOccupied\n  brokerId\n  ssid\n  buildingId\n  county\n  newConstructionType\n  daysOnZillow\n  latitude\n  longitude\n  bedrooms\n  bathrooms\n  livingArea\n  livingAreaValue\n  lotSize\n  lotAreaValue\n  yearBuilt\n  foreclosureTypes {\n    isBankOwned\n    wasNonRetailAuction\n    wasDefault\n  }\n  isFeatured\n  postingUrl\n  providerListingID\n  isPremierBuilder\n  rentalApplicationsAcceptedType\n  brokerageName\n  currency\n  propertyTypeDimension\n  hdpTypeDimension\n  listingTypeDimension\n  featuredListingTypeDimension\n  brokerIdDimension\n  keystoneHomeStatus\n  pageUrlFragment\n  contingentListingType\n  isRentalsLeadCapMet\n  isPaidMultiFamilyBrokerId\n  timeZone\n  resoFacts {\n    otherFacts {\n      value\n      name\n    }\n  }\n  virtualTourUrl\n  bedrooms\n  bathrooms\n  ...IMXRichMedia_property\n  ...NcVariant_property\n  ...ShouldShowFloorMap_property\n  ...ShouldShowVideo_property\n  ...ShouldShowVirtualTour_property\n  ...couldShowThirdPartyVirtualTour_property\n  ...couldShowEmbeddedThirdPartyVirtualTour_property\n}\n\nfragment IMXRichMedia_property on Property {\n  richMedia {\n    imx {\n      viewerUrl\n      revisionId\n      hasLocalizedPhotos\n      isLmsTour\n    }\n  }\n}\n\nfragment ShouldShowFloorMap_property on Property {\n  homeStatus\n  richMedia {\n    floorPlan {\n      viewerUrl\n    }\n  }\n}\n\nfragment UniversalAnalyticsDataLayerFragment_property on Property {\n  ...PropertyInfoBlockFragment_property\n  ...Variant_property\n}\n\nfragment PropertyInfoBlockFragment_property on Property {\n  zpid\n  buildingId\n  virtualTourUrl\n  isPremierBuilder\n  isShowcaseListing\n  thirdPartyVirtualTour {\n    providerKey\n  }\n  ...ShouldShowVirtualTour_property\n  ...IMXRichMedia_property\n  ...IMXLightboxEntryFragments_property\n}\n\nfragment IMXLightboxEntryFragments_property on Property {\n  isShowcaseListing\n  ...IMXPhotoView_property\n  ...IMXRichMedia_property\n  ...IMXViewContainer_property\n  ...IMXViewMenu_property\n  ...SphereViewerListing_property\n}\n\nfragment IMXPhotoView_property on Property {\n  listingMetadata {\n    mustPreferMlsPhotos\n  }\n  originalPhotos: photos {\n    caption\n    mixedSources(aspectRatio: Original) {\n      jpeg {\n        url\n        width\n      }\n      webp {\n        url\n        width\n      }\n    }\n  }\n}\n\nfragment IMXViewContainer_property on Property {\n  bedrooms\n  bathrooms\n  contingentListingType\n  homeStatus\n  listingSubType: listing_sub_type {\n    isFSBA: is_FSBA\n    isFSBO: is_FSBO\n    isPending: is_pending\n    isNewHome: is_newHome\n    isForeclosure: is_foreclosure\n    isBankOwned: is_bankOwned\n    isForAuction: is_forAuction\n    isOpenHouse: is_openHouse\n    isComingSoon: is_comingSoon\n  }\n  livingAreaValue\n  price\n  ...IMXAttribution_property\n}\n\nfragment IMXAttribution_property on Property {\n  listingAccountUserId\n  attributionInfo {\n    agentName\n    agentEmail\n    agentPhoneNumber\n    brokerName\n    mlsId\n  }\n}\n\nfragment IMXViewMenu_property on Property {\n  isUndisclosedAddress\n  address {\n    streetAddress\n    zipcode\n    city\n    state\n  }\n}\n\nfragment SphereViewerListing_property on Property {\n  streetAddress\n  listingSubType: listing_sub_type {\n    isFSBA: is_FSBA\n    isPending: is_pending\n    isNewHome: is_newHome\n    isForeclosure: is_foreclosure\n    isBankOwned: is_bankOwned\n    isForAuction: is_forAuction\n    isOpenHouse: is_openHouse\n    isComingSoon: is_comingSoon\n  }\n  zpid\n  hdpUrl\n  tourViewCount\n}\n\nfragment NotForSaleSearchPageStateParams_property on Property {\n  latitude\n  longitude\n  homeStatus\n  cityId\n  stateId\n  boroughId\n  countyId\n}\n\nfragment LastSoldListing_property on Property {\n  lastSoldListing @include(if: $includeLastSoldListing) {\n    palsId\n    photos {\n      caption\n      subjectType\n      url\n      mixedSources(aspectRatio: FourThirds) {\n        jpeg {\n          url\n          width\n        }\n        webp {\n          url\n          width\n        }\n      }\n    }\n    mlsAttribution\n  }\n}\n\nfragment viewerManager_viewer on Viewer {\n  displayName\n  email\n  emailHash\n  isAdmin\n  name\n  roles {\n    isAgent\n  }\n  zuid\n}\n\nfragment DebugPanel_viewer on Viewer {\n  zuid\n  isAdmin\n}\n\nfragment NfsActionBarContent_viewer on Viewer {\n  ...ActionBarController_viewer\n}\n\nfragment ActionBarController_viewer on Viewer {\n  ...DsActionBar_viewer\n}\n\nfragment DsActionBar_viewer on Viewer {\n  email\n  ...SuperShareMenu_viewer\n}\n\nfragment SuperShareMenu_viewer on Viewer {\n  ...Share_viewer\n}\n\nfragment Share_viewer on Viewer {\n  email\n}\n\nfragment NfsLightboxes_viewer on Viewer {\n  ...ReportProblemLightbox_viewer\n  ...MapLightboxContainer_viewer\n  ...MixedMediaLightbox_viewer\n}\n\nfragment ReportProblemLightbox_viewer on Viewer {\n  email\n}\n\nfragment MapLightboxContainer_viewer on Viewer {\n  ...GalleryLightboxMapGoogle_viewer\n}\n\nfragment GalleryLightboxMapGoogle_viewer on Viewer {\n  ...GetShareWithCaseManagerEnabled_viewer\n}\n\nfragment GetShareWithCaseManagerEnabled_viewer on Viewer {\n  roles {\n    isLlpRenter\n  }\n}\n\nfragment MixedMediaLightbox_viewer on Viewer {\n  ...GetShareWithCaseManagerEnabled_viewer\n}\n\nfragment NfsDataViewContent_viewer on Viewer {\n  roles {\n    isAgent\n  }\n  ...viewerManager_viewer\n  ...DsFooterSection_viewer\n}\n\nfragment DsFooterSection_viewer on Viewer {\n  isAdmin\n}\n\nfragment PageViewTracker_viewer on Viewer {\n  emailHash\n}\n\nfragment OwnerOptions_abTests on ABTests {\n  ELE_WEB_NFSHDP_MFE: abTest(trial: "ELE_WEB_NFSHDP_MFE")\n}\n\nfragment abTestManager_abTests on ABTests {\n  AB_DASHBOARD_AA_TEST: abTest(trial: "AB_DASHBOARD_AA_TEST")\n  ACTIVATION_ENABLED: abTest(trial: "Activation_Enabled")\n  ACTIVATION_ONBOARDING: abTest(trial: "Activation_Onboarding")\n  ACTIVATION_ONBOARDING_ENABLED: abTest(trial: "Activation_Onboarding_Enabled")\n  ACTIVATION_GA_METRICS_ENABLED: abTest(trial: "Activation_GA_Metrics_Enabled")\n  AIPERS_SIMILAR_HOMES_GDP: abTest(trial: "AIPERS_SIMILAR_HOMES_GDP")\n  AR_CSAT_ONSITE_HDP: abTest(trial: "AR_CSAT_ONSITE_HDP")\n  AR_CSAT_MODAL_HDP_LOAD_DELAY: abTest(trial: "AR_CSAT_MODAL_HDP_LOAD_DELAY")\n  AR_SHOWCASE_HDP_WIDGET: abTest(trial: "AR_SHOWCASE_HDP_WIDGET")\n  HDP_CONSTELLATION_PROPERTY_CARD: abTest(\n    trial: "HDP_CONSTELLATION_PROPERTY_CARD"\n  )\n  HDP_DESKTOP_LAYOUT_TOPNAV: abTest(trial: "HDP_DESKTOP_LAYOUT_TOPNAV")\n  HDP_EARLY_TRIAGE_REORDER: abTest(trial: "HDP_EARLY_TRIAGE_REORDER")\n  HDP_EARLY_TRIAGE_REORDER_APP: abTest(trial: "HDP_EARLY_TRIAGE_REORDER_APP")\n  HDP_FNF_BULLETS: abTest(trial: "HDP_FNF_BULLETS")\n  HDP_HFF_ACCORDION: abTest(trial: "HDP_HFF_ACCORDION")\n  HDP_HIGHLIGHT_OFFER_REVIEW: abTest(trial: "HDP_HIGHLIGHT_OFFER_REVIEW")\n  HDP_HOLLYWOOD_FS_SUBTYPES: abTest(trial: "HDP_HOLLYWOOD_FS_SUBTYPES")\n  HDP_HOME_INSIGHTS: abTest(trial: "HDP_HOME_INSIGHTS")\n  HDP_INSIGHTS_VERSION: abTest(trial: "HDP_INSIGHTS_VERSION")\n  HDP_REORDER_AT_A_GLANCE: abTest(trial: "HDP_REORDER_AT_A_GLANCE")\n  HDP_SELLING_SOON_MSG: abTest(trial: "HDP_SELLING_SOON_MSG")\n  HDP_SELLING_SOON_V2_TEST: abTest(trial: "HDP_SELLING_SOON_V2_TEST")\n  HDP_TOP_SLOT: abTest(trial: "HDP_TOP_SLOT")\n  HDP_UPDATED_FNF: abTest(trial: "HDP_UPDATED_FNF")\n  HDP_ZHVI_CHART_MIGRATION: abTest(trial: "HDP_ZHVI_CHART_MIGRATION")\n  MIGHTY_MONTH_2022_HOLDOUT: abTest(trial: "MIGHTY_MONTH_2022_HOLDOUT")\n  MTT_GDP_PVS_CALL_GATE: abTest(trial: "MTT_GDP_PVS_CALL_GATE")\n  NFSHDP_OWNER_OPTIONS_GOOGLE_AD: abTest(trial: "NFSHDP_OWNER_OPTIONS_GOOGLE_AD")\n  PERF_DEFER_PHOTOS: abTest(trial: "PERF_DEFER_PHOTOS")\n  PERF_PRELOAD_HDP_IMAGE: abTest(trial: "PERF_PRELOAD_HDP_IMAGE")\n  RE_CANADA_CTA: abTest(trial: "RE_CANADA_CTA")\n  RE_HDP_HOME_INSIGHTS: abTest(trial: "RE_HDP_HOME_INSIGHTS")\n  RE_HDP_HOME_INSIGHTS_VERSION: abTest(trial: "RE_HDP_HOME_INSIGHTS_VERSION")\n  RE_VARIANT_HDP_DEFERRED_HYDRATION: abTest(\n    trial: "RE_VARIANT_HDP_DEFERRED_HYDRATION"\n  )\n  RE_NON_VARIANT_HDP_DEFERRED_HYDRATION: abTest(\n    trial: "RE_NON_VARIANT_HDP_DEFERRED_HYDRATION"\n  )\n  SI_DownPaymentAssistance: abTest(trial: "SI_DownPaymentAssistance")\n  SI_DPA_Apps: abTest(trial: "SI_DPA_Apps")\n  SI_CostAndFees_HDP_Triage: abTest(trial: "SI_CostAndFees_HDP_Triage")\n  SPT_RENDER_FOR_RENT_PAGE: abTest(trial: "SPT_RENDER_FOR_RENT_PAGE")\n  TRACK_HOME_VALUE_V1: abTest(trial: "TRACK_HOME_VALUE_V1")\n  UnassistedHomeShowingWeb: abTest(trial: "UnassistedHomeShowingWeb")\n  SPT_RENDER_FOR_SALE_PAGE: abTest(trial: "SPT_RENDER_FOR_SALE_PAGE")\n  VL_BDP_NEW_TAB: abTest(trial: "VL_BDP_NEW_TAB")\n  HDP_NEW_ZESTIMATE_CHART: abTest(trial: "HDP_NEW_ZESTIMATE_CHART")\n  ZEXP_HOLDOUT_ES_PILOT: abTest(trial: "ZEXP_HOLDOUT_ES_PILOT")\n  ZHL_HDP_CHIP_PERSONALIZE_PAYMENT_CTAS: abTest(\n    trial: "ZHL_HDP_CHIP_PERSONALIZE_PAYMENT_CTAS"\n  )\n  ZHL_HDP_CHIP_PERSONALIZE_PAYMENT_PERSISTENCE: abTest(\n    trial: "ZHL_HDP_CHIP_PERSONALIZE_PAYMENT_PERSISTENCE"\n  )\n  ZHL_PERSONALIZED_PAYMENT_WEB_MVP: abTest(\n    trial: "ZHL_PERSONALIZED_PAYMENT_WEB_MVP"\n  )\n  ZHL_PERSONALIZED_PAYMENT_MODULE: abTest(\n    trial: "ZHL_PERSONALIZED_PAYMENT_MODULE"\n  )\n}\n\nfragment NfsDataViewContent_abTests on ABTests {\n  VSTA_NFS_HDP_HOLLYWOOD: abTest(trial: "VSTA_NFS_HDP_HOLLYWOOD")\n  ZHL_PERSONALIZED_PAYMENT_MODULE: abTest(\n    trial: "ZHL_PERSONALIZED_PAYMENT_MODULE"\n  )\n  Activation_Hollywood_Enabled: abTest(trial: "Activation_Hollywood_Enabled")\n  Activation_Onboarding_Enabled: abTest(trial: "Activation_Onboarding_Enabled")\n  ACTIVATION_UPSELL_CONTENT: abTest(trial: "ACTIVATION_UPSELL_CONTENT")\n  SELLER_AGENT_SHOPPING_PILOT_WEB_TOF: abTest(\n    trial: "SELLER_AGENT_SHOPPING_PILOT_WEB_TOF"\n  )\n  ...HomeValue_abTests\n  ...abTestManager_abTests\n  ...ClaimsUpsell_abTests\n  ...ComparableHomesModule_abTests\n}\n\nfragment HomeValue_abTests on ABTests {\n  ...ZestimateSummary_abTests\n}\n\nfragment ZestimateSummary_abTests on ABTests {\n  TRACK_HOME_VALUE_V1: abTest(trial: "TRACK_HOME_VALUE_V1")\n  STABLE_HOME_VALUE_MODULE: abTest(trial: "STABLE_HOME_VALUE_MODULE")\n}\n\nfragment ClaimsUpsell_abTests on ABTests {\n  NFSHDP_CLAIMS_UPSELL: abTest(trial: "NFSHDP_CLAIMS_UPSELL")\n}\n\nfragment ComparableHomesModule_abTests on ABTests {\n  ...CompsModule_abTests\n}\n\nfragment CompsModule_abTests on ABTests {\n  ...CompsMapSection_abTests\n}\n\nfragment CompsMapSection_abTests on ABTests {\n  NFSHDP_COMPS_MODULE_MAP: abTest(trial: "NFSHDP_COMPS_MODULE_MAP")\n}\n\nfragment UniversalAnalyticsDataLayerFragment_abTests on ABTests {\n  ...PropertyInfoBlockFragment_abTests\n  ...Variant_abTests\n}\n\nfragment PropertyInfoBlockFragment_abTests on ABTests {\n  ...IMXLightboxEntryFragments_abTests\n}\n\nfragment IMXLightboxEntryFragments_abTests on ABTests {\n  IMX_REPORT_PROBLEM: abTest(trial: "IMX_REPORT_PROBLEM")\n  RMX_HIGH_RES_PHOTO: abTest(trial: "RMX_HIGH_RES_PHOTO")\n  ...IMXViewContainer_abTests\n  ...SphereViewerContainer_abTests\n  ...IMXViewMenu_abTests\n}\n\nfragment IMXViewContainer_abTests on ABTests {\n  ...IMXAttribution_abTests\n}\n\nfragment IMXAttribution_abTests on ABTests {\n  DELETE_WHEN_REAL_TRIAL_ADDED: abTest(trial: "DELETE_WHEN_REAL_TRIAL_ADDED")\n}\n\nfragment SphereViewerContainer_abTests on ABTests {\n  DELETE_WHEN_REAL_TRIAL_ADDED: abTest(trial: "DELETE_WHEN_REAL_TRIAL_ADDED")\n}\n\nfragment IMXViewMenu_abTests on ABTests {\n  GROUP_BY_ROOM_TOGGLE_IMX_LIGHTBOX: abTest(\n    trial: "GROUP_BY_ROOM_TOGGLE_IMX_LIGHTBOX"\n  )\n}\n\nfragment Variant_abTests on ABTests {\n  SPT_RENDER_FOR_SALE_PAGE: abTest(trial: "SPT_RENDER_FOR_SALE_PAGE")\n}\n',
}

        params = {
            'zpid': str(zpid),
            'altId': '',
            'deviceType': 'desktop',
            'deviceTypeV2': 'WEB_DESKTOP',
            'useOmpV2': 'true',
            'includeLastSoldListing': 'false',
            'operationName': 'NotForSaleShopperPlatformFullRenderQuery',
        }

        print(f"Making request for ZPID [{zpid}]")
        time.sleep(2)
        response = self.post('https://www.zillow.com/graphql/', params=params, json=data)
        print(f"Response [{response.status_code}]")
        js_result = response.json()
        print(js_result)
        data = js_result.get('data', {})
        property_details = data.get("property", {})
        price_history = property_details.get("priceHistory", [])

        records = []
        for record in price_history:
            records.append({
                "zpid": zpid,
                "price": record.get("price"),
                "time": record.get("time"),
                "date": record.get("date"),
                "price_per_sq_ft": record.get("pricePerSquareFoot"),
                "price_change_rate": record.get("priceChangeRate"),
                "event": record.get("event"),
            })
        return records

    def _get_db_connection(self):
        """Create database connection from environment variables"""
        return psycopg2.connect(
            dbname=os.environ.get("DB_NAME", "groceries"),
            user=os.environ["DB_USER"],
            password=os.environ["DB_PASSWORD"],
            host=os.environ["DB_HOST"],
            port=os.environ.get("DB_PORT", "5432")
        )

    def save_price_history(self, records: List[Dict]):
        """Save price history records to database"""
        if not records:
            print(f"No price history records to save")
            return

        conn = None
        try:
            conn = self._get_db_connection()
            cur = conn.cursor()

            insert_query = """
                INSERT INTO price_history (
                    zpid, price, time, date,
                    price_per_sq_ft, price_change_rate, event
                ) VALUES (
                    %s, %s, %s, %s, %s, %s, %s
                )
                ON CONFLICT (zpid, time, event) DO NOTHING
            """

            values = []
            for record in records:
                values.append((
                    record.get('zpid'),
                    record.get('price'),
                    record.get('time'),
                    record.get('date'),
                    record.get('price_per_sq_ft'),
                    record.get('price_change_rate'),
                    record.get('event')
                ))

            execute_batch(cur, insert_query, values)
            conn.commit()

            inserted_count = cur.rowcount
            print(f"Processed {len(records)} price history records for zpid {records[0]['zpid']}, inserted {inserted_count} new records")

        except Exception as e:
            if conn:
                conn.rollback()
            print(f"Error saving price history: {e}")
            raise
        finally:
            if conn:
                cur.close()
                conn.close()

    def fetch_and_save(self, zpid: int):
        """Main method to fetch and save price history for a property"""
        print(f"Fetching price history for zpid: {zpid}")
        records = self.get_property_pricing_history(zpid)
        self.save_price_history(records)

    @property
    def s3_client(self):
        """Lazy load S3 client"""
        if self._s3_client is None and self.s3_bucket:
            self._s3_client = boto3.client('s3')
        return self._s3_client

    def _load_session_data(self, city: str) -> dict:
        """Load session data from S3 or local file system"""
        filename = f"{city.lower()}.json"

        if self.s3_bucket:
            # Load from S3
            s3_key = f"{self.s3_prefix}/{filename}"
            response = self.s3_client.get_object(Bucket=self.s3_bucket, Key=s3_key)
            return json.loads(response['Body'].read().decode('utf-8'))
        else:
            # Load from local file system
            with open(f"session_data/{filename}") as f:
                return json.load(f)
